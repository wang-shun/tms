/*
bootstrap-suggest-plugin - v0.1.2
Description: 这是一个基于 bootstrap 按钮式下拉菜单组件的搜索建议插件，必须使用于按钮式下拉菜单组件上。
Author: lzwme <lzwy0820@qq.com>
Github: https://github.com/lzwme/bootstrap-suggest-plugin
Update: 2016-04-18 10:51:55
*/
define(function (require, exports, module) {var jQuery = require("jquery");!function(a){function b(a,b){window.console&&window.console.trace&&(console.trace(a),b&&console.trace(b))}function c(a){var b={};return b.id=a.attr("data-id"),b.key=a.attr("data-key"),b.index=a.attr("data-index"),b}function d(a,b,c){var d,e=b||{},f=e.id||"",g=e.key||"";c&&c.multiWord?(d=a.val().split(c.separator||" "),d[d.length-1]=g,a.val(d.join(c.separator||" ")).focus()):a.attr("data-id",f).focus().val(g),a.trigger("onSetSelectValue",[e,(c.data.value||c.result.value)[e.index]])}function e(b,c,d){if(c.is(":visible")){d.autoDropup&&setTimeout(function(){a(window).height()+a(window).scrollTop()-b.offset().top<c.height()&&b.offset().top>c.height()+a(window).scrollTop()?c.parents(".input-group").addClass("dropup"):c.parents(".input-group.dropup").removeClass("dropup")},10);var e;return"left"===d.listAlign?e={left:b.siblings("div").width()-b.parent().width(),right:"auto"}:"right"===d.listAlign&&(e={left:"auto",right:"0"}),q&&!d.showBtn&&(c.parents(".input-group").hasClass("dropup")?(e.top="auto",e.bottom=b.parent().height()):(e.top=b.parent().height(),e.bottom="auto")),d.autoMinWidth===!1&&(e["min-width"]=b.parent().width()),c.css(e),b}}function f(a,b){var c,d,e;return-1===b.indexId&&!b.idField||b.multiWord?a:(c=a.css("background-color").replace(/ /g,"").split(",",3).join(","),d=b.inputBgColor||"rgba(255,255,255,0.1)",e=b.inputWarnColor||"rgba(255,255,0,0.1)",!a.val()||a.attr("data-id")?a.css("background",d):(-1===e.indexOf(c)&&(a.trigger("onUnsetSelectValue"),a.css("background",e)),a))}function g(a,b,c){var d,e,f=a.parent().find("tbody tr."+c.listHoverCSS);f.length&&(d=(f.index()+3)*f.height(),e=Number(b.css("max-height").replace("px","")),d>e||b.scrollTop()>e?b.scrollTop(d-e):b.scrollTop(0))}function h(a,b){a.find("tr."+b.listHoverCSS).removeClass(b.listHoverCSS)}function i(b,c){var d=a(b),e=d.parent(".input-group").find("ul.dropdown-menu"),f=d.data("bsSuggest");return e.length?f?!1:(d.data("bsSuggest",{target:b,options:c}),!0):!1}function j(a){var c=!0;for(var d in a)if("value"===d){c=!1;break}return c?(b("返回数据格式错误!"),!1):a.value.length?a:!1}function k(b,c){return"__index"===b||a.isArray(c.effectiveFields)&&c.effectiveFields.length>0&&-1===a.inArray(b,c.effectiveFields)?!1:!0}function l(b,c){return-1!==a.inArray(b,c.searchFields)?!0:!1}function m(a,b,c){var d,f,g,h,i,j,l=a.parent().find("ul.dropdown-menu"),m=0,n=['<table class="table table-condensed table-sm">'];if(b=c.processData(b),b===!1||!(d=b.value.length))return l.empty().hide(),a;if(c._lastData&&JSON.stringify(c._lastData.value)===JSON.stringify(b.value)&&l.find("tr").length===b.value.length)return l.show(),e(a,l,c),a;if(c._lastData=b,c.showHeader){n.push("<thead><tr>");for(g in b.value[0])k(g,c)!==!1&&(0===m?n.push("<th>"+(c.effectiveFieldsAlias[g]||g)+"("+d+")</th>"):n.push("<th>"+(c.effectiveFieldsAlias[g]||g)+"</th>"),m++);n.push("</tr></thead>")}for(n.push("<tbody>"),f=0;d>f;f++){m=0,h=[],i=b.value[f][c.idField]||"",j=b.value[f][c.keyField]||"";for(g in b.value[f])j||c.indexKey!==m||(j=b.value[f][g]),i||c.indexId!==m||(i=b.value[f][g]),m++,k(g,c)!==!1&&h.push('<td data-name="',g,'">',b.value[f][g],"</td>");n.push('<tr data-index="',b.value[f].__index||f,'" data-id="',i,'" data-key="',j,'">',h.join(""),"</tr>")}return n.push("</tbody></table>"),l.html(n.join("")).show(),setTimeout(function(){!q&&l.height()<l.find("table:eq(0)").height()&&Number(l.css("min-width").replace("px",""))<l.width()?l.css("padding-right","20px").find("table:eq(0)").css("margin-bottom","20px"):l.css("padding-right",0).find("table:eq(0)").css("margin-bottom",0)},301),e(a,l,c),a}function n(c,d){d=d||"";var e={type:"GET",url:function(){var a="?";return/=$/.test(c.url)?a="":/\?/.test(c.url)&&(a="&"),c.url+a+d}(),dataType:"json",timeout:5e3};return c.jsonp&&(e.jsonp=c.jsonp,e.dataType="jsonp"),a.isFunction(c.fnAdjustAjaxParam)&&(e=a.extend(e,c.fnAdjustAjaxParam(d,c))),a.ajax(e).done(function(a){c.data=a}).fail(b)}function o(b,c,d,e){var f,g,h,i,m,o={value:[]};if(b=b||"",a.isFunction(e.fnPreprocessKeyword)&&(b=e.fnPreprocessKeyword(b,e)),e.url)n(e,b).done(function(a){d(c,a,e),c.trigger("onDataRequestSuccess",a),"firstByUrl"===e.getDataMethod?e.url=null:e.result=e.processData(a)});else{if(f=e.data,g=j(f))if(b){for(m=f.value.length,h=0;m>h;h++)for(i in f.value[h])if(a.trim(f.value[h][i])&&(l(i,e)||k(i,e))&&(-1!==f.value[h][i].toString().indexOf(b)||-1!==b.indexOf(f.value[h][i]))){o.value.push(f.value[h]),o.value[o.value.length-1].__index=h;break}}else o=f;d(c,o,e)}}function p(a){return j(a)}var q=!!window.ActiveXObject||"ActiveXObject"in window,r={init:function(b){var j=this;return!b.showHeader&&b.effectiveFields&&b.effectiveFields.length>1&&(b.showHeader=!0),"firstByUrl"===b.getDataMethod&&b.url&&!b.delayUntilKeyup&&n(b,"").done(function(a){b.url=null,j.trigger("onDataRequestSuccess",a)}),a("#bsSuggest").length||a("head:eq(0)").append('<style id="bsSuggest">.'+b.listHoverCSS+"{"+b.listHoverStyle+"}</style>"),j.each(function(){var j,k=a(this),l=k.parents(".input-group:eq(0)").find("ul.dropdown-menu");return i(this,b)===!1?void console.warn("不是一个标准的 bootstrap 下拉式菜单或已初始化:",this):(b.showBtn||k.css("border-radius","4px").parents(".input-group:eq(0)").css("width","100%").find(".input-group-btn>.btn").hide(),k.removeClass("disabled").attr("disabled",!1).attr("autocomplete","off"),l.css(b.listStyle),b.inputBgColor||(b.inputBgColor=k.css("background-color")),k.on("keydown",function(e){var f,i="";if("none"!==l.css("display")){if(f=l.find("."+b.listHoverCSS),i="",e.keyCode===b.keyDown){if(f.length?f.next().length?(h(l,b),i=c(f.next().mouseover())):(h(l,b),b.autoSelect&&a(this).val(a(this).attr("alt")).attr("data-id","")):i=c(l.find("table tbody tr:first").mouseover()),g(k,l,b),!b.autoSelect)return}else if(e.keyCode===b.keyUp){if(f.length?f.prev().length?(h(l,b),i=c(f.prev().mouseover())):(h(l,b),b.autoSelect&&a(this).val(a(this).attr("alt")).attr("data-id","")):i=c(l.find("table tbody tr:last").mouseover()),g(k,l,b),!b.autoSelect)return}else e.keyCode===b.keyEnter?(i=c(f),l.hide().empty()):a(this).attr("data-id","");i&&""!==i.key&&d(a(this),i,b)}}).on("keyup",function(c){var d,e;return c.keyCode===b.keyDown||c.keyCode===b.keyUp||c.keyCode===b.keyEnter?(a(this).val(a(this).val()),void f(k,b)):(a(this).attr("data-id",""),f(k,b),d=a(this).val(),void((""===a.trim(d)||d!==a(this).attr("alt"))&&(a(this).attr("alt",a(this).val()),b.multiWord&&(e=d.split(b.separator||" "),d=e[e.length-1]),(d.length||b.allowNoKeyword)&&b.getData(a.trim(d),k,m,b))))}).on("focus",function(){e(k,l,b)}).on("blur",function(){j||l.css("display","")}).on("click",function(){var c,d=a(this).val();return""!==a.trim(d)&&d===a(this).attr("alt")&&l.find("table tr").length?l.show():void("none"===l.css("display")&&(b.multiWord&&(c=d.split(b.separator||" "),d=c[c.length-1]),(d.length||b.allowNoKeyword)&&b.getData(a.trim(d),k,m,b)))}),k.parent().find("button:eq(0)").attr("data-toggle","").on("click",function(){var a;return"none"===l.css("display")?(a="block",b.url?(k.click().focus(),l.find("tr").length||(a="none")):m(k,b.data,b)):a="none",l.css("display",a),!1}),void l.on("mouseenter",function(){j=1,k.blur()}).on("mouseleave",function(){j=0,k.focus()}).on("mouseenter","tbody tr",function(){return h(l,b),a(this).addClass(b.listHoverCSS),!1}).on("mousedown","tbody tr",function(){d(k,c(a(this)),b),f(k,b),l.hide()}))})},show:function(){var a=this.data("bsSuggest");return a&&a.options&&this.click(),this},hide:function(){var a=this.data("bsSuggest");return a&&a.options&&this.parent().find("ul.dropdown-menu").css("display",""),this},disable:function(){return this.data("bsSuggest")?void this.attr("disabled",!0).parent().find(".input-group-btn>.btn").addClass("disabled"):!1},enable:function(){return this.data("bsSuggest")?void this.attr("disabled",!1).parent().find(".input-group-btn>.btn").removeClass("disabled"):!1},destroy:function(){this.off().removeData("bsSuggest").parent().find(".input-group-btn>.btn").off()},version:function(){return"0.1.2"}},s={url:null,jsonp:null,data:{},getDataMethod:"firstByUrl",delayUntilKeyup:!1,indexId:0,indexKey:0,idField:"",keyField:"",effectiveFields:[],effectiveFieldsAlias:{},searchFields:[],showHeader:!1,showBtn:!0,allowNoKeyword:!0,multiWord:!1,separator:",",processData:p,getData:o,fnAdjustAjaxParam:null,fnPreprocessKeyword:null,autoMinWidth:!1,autoDropup:!1,autoSelect:!0,listAlign:"left",inputBgColor:"",inputWarnColor:"rgba(255,0,0,.1)",listStyle:{"padding-top":0,"max-height":"310px","max-width":"800px",overflow:"auto",width:"auto",transition:"0.3s","-webkit-transition":"0.3s","-moz-transition":"0.3s","-o-transition":"0.3s"},listHoverStyle:"background: #07d; color:#fff",listHoverCSS:"jhover",keyLeft:37,keyUp:38,keyRight:39,keyDown:40,keyEnter:13};a.fn.bsSuggest=function(b){return"string"==typeof b&&r[b]?r[b].apply(this,[].slice.call(arguments,1)):"object"!=typeof b&&b?void 0:(b=a.extend(!0,{},s,b),r.init.apply(this,arguments))}}(jQuery);});